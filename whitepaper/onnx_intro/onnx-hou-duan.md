# ğŸ¥³ ONNXåç«¯

### What is an ONNX backend

ONNX åç«¯æ˜¯ä¸€ä¸ªå¯ä»¥è¿è¡Œ ONNX æ¨¡å‹çš„åº“ã€‚ç”±äºè®¸å¤šæ·±åº¦å­¦ä¹ æ¡†æ¶å·²ç»å­˜åœ¨ï¼Œæ‚¨ä¸éœ€è¦ä»å¤´å¼€å§‹åˆ›å»ºä¸€åˆ‡ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œå°† ONNX æ¨¡å‹è½¬æ¢ä¸ºç›¸åº”æ¡†æ¶çš„ç‰¹å®šè¡¨ç¤ºå½¢å¼ï¼Œç„¶åå§”æ‰˜æ¡†æ¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œonnx-caffe2ï¼ˆä½œä¸º caffe2 çš„ä¸€éƒ¨åˆ†ï¼‰ã€onnx-coreml å’Œ onnx-tensorflow éƒ½æ˜¯ä½œä¸ºè½¬æ¢å™¨å®ç°çš„ã€‚

### Unified backend interface

ONNX åœ¨ `onnx/backend/base.py` ä¸­å®šä¹‰äº†ç»Ÿä¸€çš„ï¼ˆPythonï¼‰åç«¯æ¥å£ã€‚

è¯¥æ¥å£æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ: `Device`, `Backend` and `BackendRep`.

* `Device` æ˜¯å¯¹å„ç§ç¡¬ä»¶çš„è½»é‡çº§æŠ½è±¡ï¼Œ e.g., CPU, GPU, etc.
*   `Backend` æ˜¯ä¸€ä¸ªå®ä½“ï¼Œå®ƒæ¥å— ONNX æ¨¡å‹çš„è¾“å…¥ï¼Œæ‰§è¡Œè®¡ç®—ï¼Œç„¶åè¿”å›è¾“å‡ºã€‚

    å¯¹äºä¸€æ¬¡æ€§æ‰§è¡Œï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ `run_node` å’Œ `run_model` å¿«é€Ÿè·å¾—ç»“æœã€‚

    å¯¹äºé‡å¤å¤šæ¬¡çš„æ‰§è¡Œï¼Œç”¨æˆ·åº”ä½¿ç”¨ `prepare`ï¼Œå³åç«¯ä¸ºé‡å¤æ‰§è¡Œæ¨¡å‹åšçš„æ‰€æœ‰å‡†å¤‡å·¥ä½œï¼ˆå¦‚åŠ è½½åˆå§‹åŒ–å™¨ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª BackendRep å¥æŸ„ã€‚
* BackendRep æ˜¯åå°å‡†å¤‡é‡å¤å¤šæ¬¡çš„æ‰§è¡Œæ¨¡å‹åè¿”å›çš„å¥æŸ„ã€‚ç„¶åï¼Œç”¨æˆ·å°†è¾“å…¥ä¿¡æ¯ä¼ é€’ç»™ BackendRep çš„è¿è¡Œå‡½æ•°ï¼Œä»¥è·å–ç›¸åº”çš„ç»“æœã€‚

è¯·æ³¨æ„ï¼Œå°½ç®¡ ONNX ç»Ÿä¸€åç«¯æ¥å£æ˜¯ç”¨ Python å®šä¹‰çš„ï¼Œä½†åç«¯å¹¶ä¸éœ€è¦ç”¨ Python å®ç°ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç”¨ C++ åˆ›å»ºåç«¯ï¼Œå¹¶ä½¿ç”¨ pybind11 æˆ– cython ç­‰å·¥å…·æ¥å®ç°æ¥å£ã€‚

### ONNX backend test

ONNX æä¾›æ ‡å‡†çš„åç«¯æµ‹è¯•å¥—ä»¶ï¼Œä»¥ååŠ©åç«¯å®æ–½éªŒè¯ã€‚æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ¯ä¸ª ONNX åç«¯éƒ½è¿è¡Œè¯¥æµ‹è¯•ã€‚

å°† ONNX åç«¯æµ‹è¯•å¥—ä»¶é›†æˆåˆ°æ‚¨çš„ CI ä¸­éå¸¸ç®€å•ã€‚ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•é›†æˆåç«¯ï¼š

* [onnx-caffe2 onnx backend test](https://github.com/pytorch/pytorch/blob/master/caffe2/python/onnx/tests/onnx\_backend\_test.py)
* [onnx-tensorflow onnx backend test](https://github.com/onnx/onnx-tensorflow/blob/main/test/backend/test\_onnx\_backend.py)
* [onnx-coreml onnx backend test](https://github.com/onnx/onnx-coreml/blob/master/tests/onnx\_backend\_models\_test.py)

å¦‚æœå®‰è£…äº† pytestï¼Œå°±èƒ½åœ¨è¿è¡Œ ONNX åç«¯æµ‹è¯•åè·å¾—è¦†ç›–ç‡æŠ¥å‘Šï¼š

```sh
---------- onnx coverage: ----------
Operators (passed/loaded/total): 21/21/70
------------------------------------
â•’â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â••
â”‚ Operator           â”‚ Attributes         â”‚
â”‚                    â”‚ (name: #values)    â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ Slice              â”‚ axes: 2            â”‚
â”‚                    â”‚ ends: 3            â”‚
â”‚                    â”‚ starts: 3          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Constant           â”‚ value: 1           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Concat             â”‚ axis: 0            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Conv               â”‚ group: 6           â”‚
â”‚                    â”‚ kernel_shape: 5    â”‚
â”‚                    â”‚ pads: 4            â”‚
â”‚                    â”‚ strides: 3         â”‚
â”‚                    â”‚ auto_pad: 0        â”‚
â”‚                    â”‚ dilations: 0       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Reshape            â”‚ shape: 9           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BatchNormalization â”‚ consumed_inputs: 1 â”‚
â”‚                    â”‚ epsilon: 2         â”‚
â”‚                    â”‚ is_test: 1         â”‚
â”‚                    â”‚ momentum: 0        â”‚
â”‚                    â”‚ spatial: 0         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dropout            â”‚ is_test: 1         â”‚
â”‚                    â”‚ ratio: 2           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MaxPool            â”‚ kernel_shape: 2    â”‚
â”‚                    â”‚ pads: 3            â”‚
â”‚                    â”‚ strides: 2         â”‚
â”‚                    â”‚ auto_pad: 0        â”‚
â”‚                    â”‚ dilations: 0       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Transpose          â”‚ perm: 1            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MatMul             â”‚ No attributes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Relu               â”‚ No attributes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LRN                â”‚ alpha: 2           â”‚
â”‚                    â”‚ beta: 1            â”‚
â”‚                    â”‚ bias: 2            â”‚
â”‚                    â”‚ size: 1            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Add                â”‚ axis: 1            â”‚
â”‚                    â”‚ broadcast: 1       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Abs                â”‚ No attributes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pad                â”‚ mode: 3            â”‚
â”‚                    â”‚ paddings: 2        â”‚
â”‚                    â”‚ value: 1           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Softmax            â”‚ axis: 0            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GlobalAveragePool  â”‚ No attributes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mul                â”‚ axis: 1            â”‚
â”‚                    â”‚ broadcast: 1       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sum                â”‚ No attributes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gemm               â”‚ broadcast: 1       â”‚
â”‚                    â”‚ transB: 1          â”‚
â”‚                    â”‚ alpha: 0           â”‚
â”‚                    â”‚ beta: 0            â”‚
â”‚                    â”‚ transA: 0          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AveragePool        â”‚ kernel_shape: 3    â”‚
â”‚                    â”‚ pads: 3            â”‚
â”‚                    â”‚ strides: 2         â”‚
â”‚                    â”‚ auto_pad: 0        â”‚
â•˜â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•›
```

`Operators (passed/loaded/total)` ä¸€è¡Œä¸­çš„æ•°å­—ï¼š21/21/70 è¡¨ç¤ºåç«¯æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¸­æ¶‰åŠçš„ 21 ä¸ªè¿ç®—ç¬¦å·²é€šè¿‡ï¼ŒONNX åç«¯çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¸­æ¶‰åŠ 21 ä¸ªè¿ç®—ç¬¦ï¼ŒONNX å…±æœ‰ 70 ä¸ªè¿ç®—ç¬¦ã€‚
