# ğŸ«° æµ®ç‚¹è¿ç®—äº§ç”Ÿçš„è¯¯å·®

### å¦‚ä½•å°†åè¿›åˆ¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶

1. æ•´æ•°ğŸŒ°

<figure><img src="../../.gitbook/assets/å›¾ç‰‡ (58).png" alt="" width="563"><figcaption></figcaption></figure>

æ‰€ä»¥`100`çš„äºŒè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯`1100100`ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥ç”¨`windows`è‡ªå¸¦çš„ç¨‹åºå‘˜è®¡ç®—å™¨å¤šè¯•å‡ ä¸ªä¾‹å­

2. å°æ•°ğŸŒ°

<figure><img src="../../.gitbook/assets/1 _UDEaOX40DMPegaL47230A (1).webp" alt="" width="466"><figcaption></figcaption></figure>

æ‰€ä»¥0.375çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º0.011

åœ¨çœ‹ä¸€ä¸ªç¨å¾®ç‰¹æ®Šçš„ä¾‹å­ï¼š0.1çš„äºŒè¿›åˆ¶åº”è¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿ

<figure><img src="../../.gitbook/assets/1 65lZwfJ7YpHe_j5xt4BKzA.webp" alt="" width="249"><figcaption></figcaption></figure>

å¯ä»¥çœ‹å‡ºæ˜¯æ— é™å¾ªç¯çš„ï¼Œ`0.1`çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º`000110011001100...`,äºæ˜¯è¯¯å·®å°±äº§ç”Ÿäº†ã€‚

### IEEE754æ ‡å‡†ä¸‹ä¸‹çš„9.1

1. äºŒè¿›åˆ¶è¡¨ç¤º9ä¸ºï¼š`1001`
2. äºŒè¿›åˆ¶è¡¨ç¤º0.1ä¸ºï¼š`0001100110011001100...`
3. 9.1äºŒè¿›åˆ¶è½¬æ¢åä¸º`1001.0001100110011001100...`ï¼Œå†™æˆç§‘å­¦è¡¨ç¤ºæ³•å°±æ˜¯ï¼š`1.0010001100110011001100â€¦ x 2Â³`
4. æŒ‡æ•°ä½ä¸º3+127 = 130ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºä¸º`10000010`

<figure><img src="../../.gitbook/assets/1 tknf_RSUU5CXyUYLsNwAsQ.webp" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
ç”±äºæŒ‡æ•°å¯ä»¥æ˜¯è´Ÿæ•°ï¼Œå¦‚æœç®—å‡ºæ¥çš„æŒ‡æ•°ä¸è¶³å…«ä½ï¼Œéœ€è¦åœ¨é«˜ä½å³å·¦è¾¹è¡¥0è‡³å…«ä½ã€‚
{% endhint %}

4. åˆ†æ•°ä½ä¸º`0010001100110011001100â€¦`ï¼Œå¦‚æœä¸å¤Ÿ23ä½åˆ™åœ¨åé¢è¡¥0
5. æœ€ç»ˆ9.1æŒ‰ç…§`IEEE754`è¡¨ç¤ºå¦‚ä¸‹

<figure><img src="../../.gitbook/assets/1 qRb9t3mYCqBQCH1SXFh8bQ (1).webp" alt=""><figcaption></figcaption></figure>

6.  æ£€éªŒä¸‹ï¼Œå†è½¬å›åˆ°åè¿›åˆ¶

    <figure><img src="../../.gitbook/assets/1 ewWDv5NEibcQ246U7bvzEw.webp" alt=""><figcaption></figcaption></figure>

æ­£å¦‚æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬é¦–å…ˆå°† 9.1 è½¬æ¢ä¸º IEEE 754 æ ‡å‡†ï¼Œç„¶åå°† IEEE 754 å€¼è½¬æ¢ä¸ºåè¿›åˆ¶å€¼ï¼Œå¾—åˆ°çš„å´æ˜¯9.10000038ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„æµ®ç‚¹è¯¯å·®ã€‚

0.1 å’Œ 0.2 è¿™ä¸¤ä¸ªæ•°å€¼åœ¨äºŒè¿›åˆ¶æµ®ç‚¹æ•°ä¸­å¹¶æ²¡æœ‰ç²¾ç¡®çš„è¡¨ç¤ºï¼Œå› æ­¤ï¼Œå½“ä½ å°†åè¿›åˆ¶è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œå†å°†äºŒè¿›åˆ¶è½¬æ¢æˆåè¿›åˆ¶æ—¶ï¼Œå°±ä¼šæŸå¤±ç²¾åº¦ã€‚

æ‰€ä»¥å½“æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®—æ³•æ—¶ï¼Œåº”å½“è¦ååˆ†æ³¨æ„è¿™ç§æµ®ç‚¹æ•°å¸¦æ¥çš„è¯¯å·®ã€‚(æ›¾ç»åœ¨å›½å†…æŸä¸ªäºŒçº¿å¤§å‚çš„ä»£ç ä¸­ä¹Ÿå‘ç°äº†è¿™ç§é”™è¯¯ğŸ˜…)

{% hint style="info" %}
ä¸€äº›ç”±äºæµ®ç‚¹è¯¯å·®å¯¼è‡´çš„ä¸¥é‡äº‹æ•…ï¼š[https://www-users.cse.umn.edu/\~arnold/disasters/disasters.html?source=post\_page-----5c879c480982--------------------------------](https://www-users.cse.umn.edu/\~arnold/disasters/disasters.html?source=post\_page-----5c879c480982--------------------------------)
{% endhint %}

### æµ®ç‚¹è¯¯å·®çš„è§£å†³æ–¹æ³•

* ä½¿ç”¨`double`è€Œä¸æ˜¯`float`ç±»å‹
* å½“æ·»åŠ æµ®ç‚¹æ•°çš„æ—¶å€™ï¼Œå…ˆåŠ æœ€å°çš„æ•°
* æ·»åŠ æµ®ç‚¹æ•°åˆ—è¡¨çš„æ—¶å€™ï¼Œé¦–å…ˆå¯¹ä»–ä»¬è¿›è¡Œæ’åº

### åœ¨ C++ ä¸­çš„æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ <a href="#er-zai-c-zhong-de-fu-dian-shu-jing-du-wen-ti" id="er-zai-c-zhong-de-fu-dian-shu-jing-du-wen-ti"></a>

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»ä¸€æ®µç¨‹åºå¼€å§‹è¿™ä¸ªé—®é¢˜

```cpp
#include <iostream>

int main() {
    float a = 10.0;
    float b = 0.1;
    float c = a - b;

    std::cout << "c = " << c << "\n";

    return 0;
}

// è¾“å‡ºç»“æœï¼š9.9
```

è¿™çœ‹ä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå®åˆ™é—®é¢˜éšè—äºå†°å±±ä¹‹ä¸‹ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥è§£å¼€å®ƒï¼

å†æ¬¡å°è¯•ä¸‹é¢çš„ç¨‹åºï¼š

```cpp
#include <iostream>
#include <iomanip>

int main() {
    float a = 10.0;
    float b = 0.1;
    float c = a - b;

    std::cout << std::setiosflags(std::ios::fixed) << std::setprecision(23)
        << "c = " << c << "\n";

    return 0;
}

// è¾“å‡ºç»“æœï¼šc = 9.89999961853027343750000
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è¾“å‡ºå°æ•°å 23 ä½åå°±èƒ½å‘ç°è¿™ä¸ªç²¾åº¦ç¼ºå¤±é—®é¢˜äº†ã€‚

ç¬¬ä¸€ä¸ªä¾‹å­ä¹‹æ‰€ä»¥èƒ½å¾—åˆ°æ­£ç¡®çš„ç­”æ¡ˆæ˜¯å› ä¸º std::cout è¾“å‡ºæµå¯¹å°æ•°åšäº†å››èˆäº”å…¥æ“ä½œï¼Œé€šè¿‡å¤„ç†ç»™å‡ºäº†æ­£ç¡®ç­”æ¡ˆã€‚

çœ‹åˆ°è¿™ï¼Œä½ æˆ–è®¸è§‰å¾—è¿™æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œèƒ½å¾—åˆ°æ­£ç¡®ç­”æ¡ˆä¸å°±è¡Œäº†ï¼Ÿå…¶å®ä¸ç„¶ï¼Œç°åœ¨è®©æˆ‘ä»¬å°† `float a = 10.0;` æ¢ä¸º `float a = 500000.0`ï¼Œæˆ‘ä»¬å†æ¬¡è¿è¡Œç¨‹åºï¼Œçœ‹çœ‹èƒ½å¾—åˆ°ä»€ä¹ˆï¼ˆä½¿ç”¨é»˜è®¤è¾“å‡ºä½æ•°ï¼‰ï¼

```cpp
c = 500000
```

å¥½å®¶ä¼™ï¼Œæ‡µäº†å§ï¼ˆ500000.0 å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œå‡†ç¡®æ¥è¯´è¦ç¡®ä¿ a è¶³å¤Ÿçš„å¤§ï¼‰ï¼

å¾ˆæ˜æ˜¾ï¼Œè¿™å‡ºç°äº†é—®é¢˜ï¼å½“æˆ‘ä»¬è¾“å‡ºå°æ•°å 23 ä½æ—¶ä½ å°±ä¼šå¾—åˆ°ï¼š

```cpp
c = 499999.90625000000000000000000
```

æ‰€ä»¥ï¼Œå³ä½¿ä½ å¯ä»¥é€šè¿‡**å…è®¸è¯¯å·®**çš„æ–¹å¼æ¥åˆ¤æ–­æµ®ç‚¹æ•°æ˜¯å¦ç›¸ç­‰ï¼ˆå¤§æ¦‚ç±»ä¼¼äºä½¿ç”¨ `a - b <= 1e-12` æ¥è¿‘ä¼¼ä»£æ›¿ `a - b == 0.0` è¿™æ ·çš„åˆ¤åˆ«å¼ï¼‰ï¼Œä½ ä¹Ÿæ— æ³•é¿å…è¾“å‡ºæ˜¾ç¤ºçš„é—®é¢˜ã€‚è€Œè¿™ä¸€åˆ‡éƒ½æºäºæµ®ç‚¹æ•°çš„ç²¾åº¦ä¸¢å¤±é—®é¢˜ã€‚

### è§£å†³ C++ ä¸­çš„æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ <a href="#san-jie-jue-c-zhong-de-fu-dian-shu-jing-du-wen-ti" id="san-jie-jue-c-zhong-de-fu-dian-shu-jing-du-wen-ti"></a>

#### Booståº“

ç›®å‰ï¼Œæˆ‘å°è¯•çš„è§£å†³åŠæ³•ä¸ºä½¿ç”¨ [Boost åº“](https://www.boost.org/)ä¸­çš„ `boost::multiprecision::cpp_dec_float_50` æ¥ä»£æ›¿ `float` æˆ– `double` ç±»å‹ã€‚

```cpp
#include <iostream>
#include <boost/multiprecision/cpp_dec_float.hpp>
#include <boost/multiprecision/cpp_int.hpp>

namespace mp = boost::multiprecision;     // å‘½åç©ºé—´é‡å‘½åâ€”â€”ç¼©çŸ­å‘½åç©ºé—´
typedef mp::cpp_dec_float_50    float50;  // å˜é‡ç±»å‹åé‡å‘½åâ€”â€”ç¼©çŸ­å˜é‡ç±»å‹å
typedef mp::cpp_dec_float_100    float100;// å˜é‡ç±»å‹åé‡å‘½åâ€”â€”ç¼©çŸ­å˜é‡ç±»å‹å

int main() {
    float50 a0("50000.0");                // æ¨èå£°æ˜æ–¹å¼
    float50 b0("10.012");
    float50 c0 = a0 - b0;

    float50 a1(50000.0);                  // å› ä¸º 50000.0 ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å·²ç»å‡ºç°äº†ç²¾åº¦ä¸¢å¤±ã€‚
    float50 b1(10.012);                   // è€Œç”¨ç²¾åº¦ä¸¢å¤±åçš„æ•°å†åˆ›å»ºé«˜ç²¾åº¦å˜é‡å·²ç»æ— æ„ä¹‰ã€‚
    float50 c1 = a1 - b1;

    double a2 = 50000.0;                  // æ¼”ç¤ºç²¾åº¦ä¸¢å¤±
    double b2 = 10.012;
    double c2 = a2 - b2;

    std::cout << std::setiosflags(std::ios::fixed) << std::setprecision(25)
        << "a0\t=\t" << a0 << "\n"
        << "b0\t=\t" << b0 << "\n"
        << "c0\t=\t" << c0 << "\n\n"
        << "a1\t=\t" << a1 << "\n"
        << "b1\t=\t" << b1 << "\n"
        << "c1\t=\t" << c1 << "\n\n"
        << "a2\t=\t" << a2 << "\n"
        << "b2\t=\t" << b2 << "\n"
        << "c2\t=\t" << c2 << "\n\n";
 
    return 0;
}

/*
a0      =       50000.0000000000000000000000000
b0      =       10.0120000000000000000000000
c0      =       49989.9880000000000000000000000

a1      =       50000.0000000000000000000000000
b1      =       10.0120000000000004547473509
c1      =       49989.9879999999999995452526491

a2      =       50000.0000000000000000000000000
b2      =       10.0120000000000004547473509
c2      =       49989.9879999999975552782416344
*/
```

å¾ˆæ˜æ˜¾ï¼Œç²¾åº¦ä¸¢å¤±é—®é¢˜åœ¨ Boost åº“ä¸­å¾—åˆ°äº†å¾ˆå¥½çš„è§£å†³ã€‚å½“ç„¶ï¼ŒBoost åº“è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å…³äºæµ®ç‚¹æ•°æ“ä½œçš„ä¼˜åŒ–ï¼Œè€Œä¸”åŸºæœ¬éƒ½æ˜¯åŸºäºæºæ ‡å‡†åº“çš„æ¨¡å¼é‡å†™çš„ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥çš„éå¸¸é¡ºæ‰‹ï¼ˆæ³¨æ„å‘½åç©ºé—´å³å¯ï¼‰ã€‚

#### Kahan æ±‚å’Œ

[Kahan æ±‚å’Œ](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Kahan\_summation\_algorithm) æ˜¯ä¸€ç§è¡¥å¿çš„æ±‚å’Œç®—æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š

```cpp
float sum(const std::vector<float> &a) {
    float res = 0;
    float c = 0;
    for (auto y : a) {
        y -= c;
        float t = res + y;
        c = (t - res) - y;
        res = t;
    }
    return res;
}
```

### reference

* [https://medium.com/@kusal95/computer-floating-point-arithmetic-and-round-off-errors-5c879c480982](https://medium.com/@kusal95/computer-floating-point-arithmetic-and-round-off-errors-5c879c480982)
* [https://seayj.cn/articles/6d33/](https://seayj.cn/articles/6d33/)
* [https://zhuanlan.zhihu.com/p/673320830](https://zhuanlan.zhihu.com/p/673320830)
* [Higham N J. The accuracy of floating point summation\[J\]. SIAM Journal on Scientific Computing, 1993, 14(4): 783-799.](https://citeseerx.ist.psu.edu/document?repid=rep1\&type=pdf\&doi=5c179d447a27c40a54b2bf8b1b2d6819e63c1a69)
